import pandas as pd, numpy as np, requests, yaml, joblib
from xgboost import XGBClassifier

CFG = yaml.safe_load(open("config.yaml"))
HEAD = {"x-apisports-key": CFG["api_football_key"]}

def get_matches(league, season="2024"):
    url = f"https://v3.football.api-sports.io/fixtures?league={league}&season={season}"
    resp = requests.get(url, headers=HEAD).json()
    return pd.json_normalize(resp["response"])

def build_features(df):
    df["date"] = pd.to_datetime(df["fixture.date"])
    df["hGoals"] = pd.to_numeric(df["goals.home"], errors="coerce").fillna(0)
    df["aGoals"] = pd.to_numeric(df["goals.away"], errors="coerce").fillna(0)
    df["hLastGoals"]   = df.groupby("teams.home.id")["hGoals"].shift(1).rolling(5, min_periods=1).mean()
    df["aLastGoals"]   = df.groupby("teams.away.id")["aGoals"].shift(1).rolling(5, min_periods=1).mean()
    # escanteios
    df["hLastCorners"] = df.groupby("teams.home.id")["statistics"].apply(
        lambda x: (x[0]["statistics"][6]["value"] or 0) if len(x)>0 else 0).rolling(5, min_periods=1).mean()
    df["aLastCorners"] = df.groupby("teams.away.id")["statistics"].apply(
        lambda x: (x[1]["statistics"][6]["value"] or 0) if len(x)>1 else 0).rolling(5, min_periods=1).mean()
    # cartÃµes
    df["hLastCards"]   = df.groupby("teams.home.id")["statistics"].apply(
        lambda x: (x[0]["statistics"][4]["value"] or 0) if len(x)>0 else 0).rolling(5, min_periods=1).mean()
    df["aLastCards"]   = df.groupby("teams.away.id")["statistics"].apply(
        lambda x: (x[1]["statistics"][4]["value"] or 0) if len(x)>1 else 0).rolling(5, min_period
